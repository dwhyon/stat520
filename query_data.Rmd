```{r}
# Load libraries
library(httr)    
library(jsonlite) 
library(tidyr)   
library(dplyr)   
library(purrr)
```


```{r}
fetch_numeric_data <- function(indicator_code, column_name) {
  # Construct API URL
  url <- paste0("https://ghoapi.azureedge.net/api/",
                indicator_code, 
                "?$filter=SpatialDimType%20eq%20'COUNTRY'",
                "%20and%20NumericValue%20ne%20null",
                "%20and%20TimeDim%20ge%202000")
  
  # Fetch data from API
  response <- GET(url)
  
  # Check for successful response
  if (status_code(response) != 200) {
    stop("Failed to fetch data for indicator:", indicator_code)
  }
  
  # Parse JSON response
  data <- fromJSON(content(response, 'text', encoding = 'UTF-8'))
  
  # Process and reshape data if available
  if (!is.null(data$value)) {
    df <- data$value %>%
      select(SpatialDim, TimeDim, NumericValue, Dim1Type, Dim1) %>%
      rename(
        country = SpatialDim,
        year = TimeDim,
        !!column_name := NumericValue
      )
  } else {
    df <- tibble()  # Return empty tibble if no data
  }
  
  return(df)
}
```


[Life Expectancy at Birth](https://www.who.int/data/gho/data/indicators/indicator-details/GHO/life-expectancy-at-birth-(years))
[Alcohol, total per capita (15+) consumption (in litres of pure alcohol) (SDG Indicator 3.5.2)](https://www.who.int/data/gho/data/indicators/indicator-details/GHO/total-(recorded-unrecorded)-alcohol-per-capita-(15-)-consumption)
```{r}
# Numeric data by sex
numeric_data_by_sex_list <- list()
indicators <- list(
  c('WHOSIS_000001', 'life_expectancy_at_birth'),
  
  c('SA_0000001688', 'alc_consump_per_capita_liters'),

  c('NUTRITION_ANAEMIA_PREGNANT_PREV', 'pregnant_women_anaemia_prevalence'),
    c('NUTRITION_ANAEMIA_CHILDREN_PREV', 'children_anaemia_prevalence')
)

# Fetch and clean data for each indicator
for (indicator in indicators) {
  df <- fetch_numeric_data(indicator[1], indicator[2]) %>%
    filter(Dim1Type == 'SEX') %>%
    select(-Dim1Type) %>%
    pivot_wider(
      names_from = Dim1,
      values_from = indicator[2],
      names_prefix = paste0(indicator[2], '_')
    ) %>%
    rename_with(~ gsub('SEX_', '', .), starts_with(paste0(indicator[2], '_')))
  numeric_data_by_sex_list[[indicator[2]]] <- df
}

# Combine all immunization coverage data
numeric_data_by_sex <- reduce(numeric_data_by_sex_list, function(x, y) {
  full_join(x, y, by = c("country", "year"))
})

# Print life expectancy data
print(numeric_data_by_sex)
```


[Immunization coverage estimates](https://www.who.int/data/gho/data/themes/topics/indicator-groups/indicator-group-details/GHO/immunization-coverage-estimates)

[Alcohol expenditure as a per cent of total household expenditure](https://www.who.int/data/gho/data/indicators/indicator-details/GHO/alcohol-expenditure-as-a-per-cent-of-total-household-expenditure)

[Health financing data](https://www.who.int/data/gho/data/themes/topics/health-financing)

[Low birthweight estimates](https://www.who.int/data/gho/data/themes/topics/topic-details/GHO/low-birthweight-estimates)

[Anaemia in women and children](https://www.who.int/data/gho/data/themes/topics/anaemia_in_women_and_children)
```{r}
# Immunization coverage data
numeric_data_list <- list()
indicators <- list(
  c('WHS4_543', 'bcg_immunization_coverage'),
  c('WHS4_100', 'dtp_immunization_coverage'),
  c('WHS4_117', 'hepb3_immunization_coverage'),
  c('WHS4_129', 'hib3_immunization_coverage'),
  c('SDGHPVRECEIVED', 'hpv_immunization_coverage'),
  c('WHS8_110', 'mcv1_immunization_coverage'),
  c('MCV2', 'mcv2_immunization_coverage'),
  c('WHS4_128', 'pab_immunization_coverage'),
  c('PCV3', 'pcv3_immunization_coverage'),
  c('WHS4_544', 'pol3_immunization_coverage'),
  c('ROTAC', 'rotac_immunization_coverage'),

  c('SA_0000001476', 'alc_expenditure_%_of_household'),

  c('GHED_CHEGDP_SHA2011', 'che_%_of_gdp'),
  c('GHED_EXTCHE_SHA2011', 'ext_%_of_che'),
  c('GHED_GGHE-DCHE_SHA2011', 'gghe-d_%_of_che'),
  c('GHED_OOPSCHE_SHA2011', 'oop_%_of_che'),
  c('GHED_PVT-DCHE_SHA2011', 'pvt-d_%_of_che'),

  c('PRETERMBIRTH_RATE', 'preterm_birth_rate_per_100'),
  c('LBW_PREVALENCE', 'low_birth_weight_prevalence'),


  c('HEMOGLOBINLEVEL_PREGNANT_MEAN', 'pregnant_women_mean_hemoglobin'),
  c('HEMOGLOBINLEVEL_CHILDREN_MEAN', 'children_mean_hemoglobin')
)

# Fetch and clean data for each indicator
for (indicator in indicators) {
  df <- fetch_numeric_data(indicator[1], indicator[2]) %>%
    select(-c(Dim1Type, Dim1))
  numeric_data_list[[indicator[2]]] <- df
}

# Combine all numeric data
numeric_data <- reduce(numeric_data_list, function(x, y) {
  full_join(x, y, by = c("country", "year"))
})
```


```{r}
# Full outer join the life expectancy data with the immunization coverage data
master_df <- full_join(numeric_data_by_sex, numeric_data, by = c("country", "year"))

# Print the final combined data
print(master_df)
```

